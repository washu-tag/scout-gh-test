name: Ansible test

on:
  push:

jobs:
  ansible-install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Prepare inventory.yaml'
        shell: bash
        run:
          cp .github/inventory.yaml ansible/
      - name: 'Install prerequisites'
        shell: bash
        run:
          sudo pip3 install kubernetes
      - name: 'ansible-galaxy dependencies'
        shell: bash
        run:
          cd ansible && sudo /opt/pipx_bin/ansible-galaxy install -r collections/requirements.yaml
      - name: 'Clone scout'
        shell: bash
        run:
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/scout.yaml
      - name: 'Install k3s'
        shell: bash
        run: |
          export K8S_AUTH_KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -vvvv -v -i inventory.yaml --diff playbooks/k3s-cluster.yaml
      - name: 'Install helm and helm diff'
        shell: bash
        run:
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/helm.yaml
      - name: 'Install minio'
        shell: bash
        run:
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/minio.yaml
      - name: 'Install orchestrator'
        shell: bash
        run:
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/orchestrator.yaml