name: Ansible test

on:
  push:

env:
  REGISTRY: ghcr.io

jobs:
  ansible-install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Prepare inventory.yaml'
        shell: bash
        run:
          cp .github/inventory.yaml ansible/
      - name: 'ansible-galaxy dependencies'
        shell: bash
        run:
          cd ansible && ansible-galaxy install -r collections/requirements.yaml
      - name: 'Install k3s'
        shell: bash
        run:
          cd ansible && ansible-playbook --become-user root -vvv -v -i inventory.yaml --diff playbooks/k3s-cluster.yaml
      - name: 'Install helm and helm diff'
        shell: bash
        run:
          cd ansible && ansible-playbook -v -i inventory.yaml --diff playbooks/helm.yaml
      - name: 'Clone scout'
        shell: bash
        run:
          cd ansible && ansible-playbook -v -i inventory.yaml --diff playbooks/scout.yaml
      - name: 'Install minio'
        shell: bash
        run:
          cd ansible && ansible-playbook -v -i inventory.yaml --diff playbooks/minio.yaml
      - name: 'Install orchestrator'
        shell: bash
        run:
          cd ansible && ansible-playbook -v -i inventory.yaml --diff playbooks/orchestrator.yaml