name: Ansible test

on:
  push:

env:
  JAVA_DIST: 'zulu'
  JAVA_VERSION: '21'
  REGISTRY: ghcr.io

jobs:
  build-and-upload-artifact:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Checkout GitHub Action
        uses: actions/checkout@v4.2.1
      - name: 'Build/Cache Image - temporal-java'
        uses: ./.github/actions/docker-build-cache
        with:
          subproject: orchestration/temporal-java
          image-name: temporal-java
      - name: 'Build/Cache Image - temporal-python'
        uses: ./.github/actions/docker-build-cache
        with:
          subproject: orchestration/temporal-python
          image-name: temporal-python
  ansible-install:
    runs-on: ubuntu-latest
    needs: [build-and-upload-artifact]
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Pull and Label Image - temporal-java'
        uses: ./.github/actions/docker-tag-local
        with:
          image-name: temporal-java
      - name: 'Pull and Label Image - temporal-python'
        uses: ./.github/actions/docker-tag-local
        with:
          image-name: temporal-python
      - name: 'Prepare inventory.yaml'
        shell: bash
        run:
          cp .github/inventory.yaml ansible/
      - name: 'Install prerequisites'
        shell: bash
        run:
          sudo pip3 install kubernetes
      - name: 'ansible-galaxy dependencies'
        shell: bash
        run:
          cd ansible && sudo /opt/pipx_bin/ansible-galaxy install -r collections/requirements.yaml
      - name: 'Clone scout'
        shell: bash
        run:
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/scout.yaml
      - name: 'Install k3s'
        shell: bash
        run: |
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -vvvv -v -i inventory.yaml --diff playbooks/k3s-cluster.yaml
      - name: 'Install helm and helm diff'
        shell: bash
        run:
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/helm.yaml
      - name: 'Install minio'
        shell: bash
        run:
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/minio.yaml
      - name: 'Install orchestrator'
        shell: bash
        run: |
          docker images
          cd ansible && sudo /opt/pipx_bin/ansible-playbook -vvvv -i inventory.yaml --diff playbooks/orchestrator.yaml || sudo kubectl -n temporal get events
          sudo kubectl -n temporal describe nodes
          sudo kubectl -n temporal describe pods
          sudo kubectl -n orchestration-workers get events
          sudo kubectl -n orchestration-workers describe nodes
          sudo kubectl -n orchestration-workers describe pods